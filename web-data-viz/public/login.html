<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="./assets/svg/Logo.svg" type="image/x-icon">
    <link rel="stylesheet" href="./css/pages/login.css">
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://fonts.googleapis.com/css2?family=Nunito+Sans:ital,opsz,wght@0,6..12,200..1000;1,6..12,200..1000&family=Poppins:wght@100..900&display=swap" rel="stylesheet">
    <title>Login | EyesAnalytic</title>
</head>

<body>
    <div class="button-container">
        <a href="./index.html" class="back-button"></a>
    </div>

    <div class="login">
        <div class="loginTexto">
            <a href="index.html"><img src="./assets/svg/Logo.svg" alt="logo"></a>
            <h1>Login</h1>
        </div>

        <div class="input field">
            <input type="email" class="campo" placeholder="E-mail" required id="email_input" autocomplete="off">
            <label for="email_input" class="caixa">E-mail</label>
        </div>

        <div class="input field">
            <input type="password" class="campo" placeholder="Senha" required id="senha_input" autocomplete="off">
            <label for="senha_input" class="caixa">Senha</label>
        </div>

        <div id="error-message" style="color: red; display: none;"></div>
        <button type="submit" onclick="entrar()">Entrar</button>
    </div>

    <script>
        function entrar() {
            const emailVar = email_input.value;
            const senhaVar = senha_input.value;
            const errorMessage = document.getElementById("error-message");

            if (emailVar === "" || senhaVar === "") {
                Swal.fire({
                    title: "Falha!",
                    text: "Por favor, preencha todos os campos!",
                    icon: "error",
                    confirmButtonColor: '#4CAF50',
                    timer: 2000,
                    timerProgressBar: true
                });
                return;
            }

            fetch("/usuarios/autenticar", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ emailServer: emailVar, senhaServer: senhaVar })
            })
            .then(response => {
                if (response.ok) {
                    return response.json();
                } else {
                    throw new Error("Credenciais inválidas.");
                }
            })
            .then(json => {
                sessionStorage.EMAIL_USUARIO = json.email;
                sessionStorage.NOME_USUARIO = json.nome;
                sessionStorage.SITUACAO = json.situacao;
                sessionStorage.ID_USUARIO = json.idUsuario;
                sessionStorage.FK_TIPO_USUARIO = json.fkTipoUsuario;
                sessionStorage.FK_EMPRESA = json.fkEmpresa;

                const nomeUsuario = sessionStorage.getItem("NOME_USUARIO");

                if (sessionStorage.FK_TIPO_USUARIO == 1 && sessionStorage.SITUACAO === 'Ativo') {
                    Swal.fire({
                        title: "Login realizado com sucesso!",
                        text: `Olá ${nomeUsuario}!`,
                        icon: "success",
                        confirmButtonColor: '#4CAF50',
                        timer: 2000,
                        timerProgressBar: true,
                        willClose: () => window.location = "./dashboard/dash-diretor.html"
                    });
                } else if (sessionStorage.FK_TIPO_USUARIO == 2 && sessionStorage.SITUACAO === 'Ativo') {
                    Swal.fire({
                        title: "Login realizado com sucesso!",
                        text: `Olá ${nomeUsuario}!`,
                        icon: "success",
                        confirmButtonColor: '#4CAF50',
                        timer: 2000,
                        timerProgressBar: true,
                        willClose: () => window.location = "./dashboard/dash-especialista.html"
                    });
                } else if (sessionStorage.SITUACAO !== 'Inativo') {
                    Swal.fire({
                        title: "Usuário inativo",
                        text: "Esse usuário foi inativado",
                        icon: "error",
                        confirmButtonColor: '#f44336',
                        timer: 2000,
                        timerProgressBar: true
                    });
                } else {
                    Swal.fire({
                        text: "Credenciais inválidas. Por favor, tente novamente.",
                        icon: "warning",
                        confirmButtonColor: '#f44336',
                        timer: 2000,
                        timerProgressBar: true
                    });
                }
            })
            .catch(error => {
                console.error("Erro no login:", error);
                Swal.fire({
                    title: "Credenciais inválidas!",
                    text: "Sua conta ou senha está incorreta. Por favor, tente novamente!",
                    icon: "warning",
                    confirmButtonColor: '#f44336',
                    timer: 2000,
                    timerProgressBar: true
                });
                errorMessage.style.display = "block";
                errorMessage.innerText = error.message;
            });
        }
    </script>
</body>
</html>
