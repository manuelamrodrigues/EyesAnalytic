<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | EyesAnalytic</title>
    <link rel="stylesheet" href="./css/pages/dash-rede.css">
    <link rel="stylesheet" href="../css/pages/aside-menu.css">
    <link rel="shortcut icon" href="../assets/svg/Logo.svg" type="image/x-icon">
    <script src="../js/aside-menu.js"></script>
    <script src="../js/sessao.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
</head>

<body onload="listarServidor(), listarServidoresQualidade()">
    <aside id="aside-menu">
        <img src="../assets/svg/Logo.svg" alt="Logo" class="asideLogo">

        <ul id="navLinks">

            <a href="../lista-alertas-especialista.html" class="outros">
                <li>
                    <img src="../assets/svg/alert-svgrepo-com.svg" alt="Alerta">
                    <span>Alertas</span>
                </li>
            </a>

            <a href="./dash-especialista.html" class="outros">
                <li>
                    <img src="../assets/svg/dashboard-svgrepo-com.svg" alt="Dashboard">
                    <span>Dashboard</span>
                </li>
            </a>
            <a href="./dash-rede.html" class="outros">
                <li>
                    <img src="../assets/svg/gauge.svg" alt="Dashboard">
                    <span>Rede</span>
                </li>
            </a>
            <a onclick="limparSessao()" class="outros">
                <li>
                    <img src="../assets/svg/exit-svgrepo-com.svg" alt="Saída">
                    <span>Sair</span>
                </li>
            </a>

        </ul>
        <div class="menu" id="menu-hamburguer">
            <div class="menu" id="menu-hamburguer">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" width="80px" height="10px"
                    class="hamburger-line">
                    <rect x="0" y="8" width="600" height="10" fill="white"></rect> <!-- Aumentar a altura aqui -->
                </svg>

                <!-- Linha 2 -->
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" width="80px" height="10px"
                    class="hamburger-line">
                    <rect x="0" y="24" width="600" height="10" fill="white"></rect> <!-- Aumentar a altura aqui -->
                </svg>

                <!-- Linha 3 -->
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" width="80px" height="10px"
                    class="hamburger-line">
                    <rect x="0" y="40" width="600" height="10" fill="white"></rect> <!-- Aumentar a altura aqui -->
                </svg>
            </div>

        </div>

        </div>
    </aside>
    <div id="fade" class="hide"></div>

    <main>
        <h2>Informações de Rede</h2>

        <div class="topo">

            <div class="quality">
                <div class="alinhar">
                    <h3>Qualidade da Rede</h3>
                    <div class="info-container">
                        <i class="fas fa-info-circle"></i> <!-- Ícone de informação -->
                        <!-- <p>Passe o mouse aqui para ver mais informações.</p> -->
                        <div class="info-box">
                            <span class="msg">Informação tirada da comparação da parda de pacotes e latência da
                                rede.</span>
                        </div>
                    </div>
                </div>

                <div class="qtd" id="valor">
                    <!-- <p>Média</p> -->
                </div>

                <canvas id="gaugeChart" class="gauge"></canvas>
                <div id="ponteiro"
                    style="width: 100px; height: 100px; background-image: url(./assets/svg/ponteiro.svg); background-size: cover; position: absolute; top: 170px;">
                </div>
            </div>

            <div class="topo-direita">

                <div class="selecao">
                    <select class="opcao" id="listaServidor" onchange="mudarServidor()">
                    </select>
                </div>

                <div class="indicador">
                    <div class="alinhar2">
                        <h3>Indicadores de Qualidade</h3>

                        <div class="info-container">
                            <i class="fas fa-info-circle"></i> <!-- Ícone de informação -->
                            <!-- <p>Passe o mouse aqui para ver mais informações.</p> -->
                            <div class="info-box">
                                <span class="msg">Informação tirada a partir da média de dos últimos cinco
                                    registros.</span>
                            </div>
                        </div>
                    </div>

                    <div class="op" id="op">
                    </div>
                </div>
            </div>
        </div>

        <div class="baixo">

            <div class="servidores">
                <h3>Lista de Qualidade da Rede</h3>
                <div class="lista" id="lista">
                </div>
            </div>

            <div class="baixo-direita">
                <h3>Comparação de Mbps de Upload e Download</h3>
                <div class="grafico">
                    <canvas id="myChart" class="canvas"></canvas>
                </div>
            </div>

        </div>


    </main>

</body>

</html>
<script>

    var idMaquina

    function iniciar() {
        // setTimeout(() => {
        listarIndicadores()
        iniciarGrafico()
        qualidadeDaRede()
        // }, 5000);
    }

    // listar servidores
    function listarServidor() {
        var fkEmpresa = sessionStorage.FK_EMPRESA;

        fetch(`/rede/listarServidor/${fkEmpresa}`, {
            method: "GET",
        }).then(function (resposta) {
            resposta.json().then((servidor) => {
                servidor.forEach((servidor) => {
                    console.log(servidor.idMaquina)
                    listaServidor.innerHTML += `<option value='${servidor.idMaquina}'>${servidor.nomeMaquina}</option>`;
                });

                idMaquina = servidor[0].idMaquina
                iniciar()
            });
        }).catch(function (resposta) {
            console.log(`#ERRO: ${resposta}`);
        });
    }

    // Grafico gauge
    const ctx2 = document.getElementById('gaugeChart').getContext('2d');
    const gaugeChart = new Chart(ctx2, {
        type: 'doughnut',
        data: {
            datasets: [{
                data: [50, 30, 20], // Definição dos dados
                backgroundColor: ['#4caf50', '#ffeb3b', '#f44336'],
                borderWidth: 0, // Remover borda
                circumference: 180, // Limita o gráfico a metade
                rotation: 270 // Inicia o gráfico a partir da metade inferior
            }]
        },
        options: {
            responsive: true,
            cutout: '80%', // Define o tamanho do "buraco" central do gráfico
            rotation: -90 * Math.PI / 180, // Inicia o gráfico na metade superior
            circumference: 180 * Math.PI / 180, // Faz o gráfico ocupar apenas metade
            plugins: {
                tooltip: { enabled: false } // Desabilita as tooltips
            },
        }
    });

    // QUALIDADE DA REDE
    function qualidadeDaRede() {
        let valor1 = document.getElementById("valor");
        valor1.innerHTML = ""; // Limpar conteúdo anterior

        // Recupera a qualidade da rede do banco
        fetch(`rede/buscarQualidade/${idMaquina}`, {
            method: "GET",
            headers: {
                "Content-Type": "application/json"
            }
        }).then(function (resposta) {
            return resposta.json();
        }).then(function (resposta) {
            resposta.forEach(element => {
                let valor = document.createElement("div");
                valor.className = "valor";
                valor.innerHTML = `${element.qualidadeRede || "N/A"}`;
                valor1.appendChild(valor);

                let ponteiro = document.getElementById("ponteiro");

                // setTimeout(function () {
                let novaQualidade = "";
                let anguloRotacao = 0;

                // Verificar condições para atualizar a qualidade e a rotação do ponteiro
                if (element.mediaLatencia <= 100 && element.perdaPacotes <= 10) {
                    novaQualidade = 'Estável';
                    valor.style.fontWeight = 600;
                    valor.style.fontSize = '18px';
                    valor.style.color = '#029c5e';

                    // Alterar o estilo do ponteiro - alto
                    anguloRotacao = -50;
                    ponteiro.style.top = "190px";
                    ponteiro.style.left = "240px";

                } else if ((element.mediaLatencia >= 170 && element.mediaLatencia <= 220) ||
                    (element.perdaPacotes >= 11 && element.perdaPacotes <= 20)) {
                    novaQualidade = 'Médio';
                    valor.style.fontWeight = 600;
                    valor.style.fontSize = '18px';
                    valor.style.color = '#ff9800';

                    // Alterar o estilo do ponteiro - medio
                    anguloRotacao = 40;
                    ponteiro.style.top = "185px";
                    ponteiro.style.left = "290px";

                } else {
                    novaQualidade = 'Baixa';
                    valor.style.fontWeight = 600;
                    valor.style.fontSize = '18px';
                    valor.style.color = '#f44336';

                    anguloRotacao = 80;
                    ponteiro.style.top = "205px";
                    ponteiro.style.left = "300px";
                }
                // Aplicar rotação no ponteiro
                ponteiro.style.transform = `rotate(${anguloRotacao}deg)`;

                // setTimeout(function () {
                    // Atualizar a qualidade da rede no banco se necessário
                    if (novaQualidade !== element.qualidadeRede) {
                        fetch("/rede/atualizarQualidade/", {
                            method: "PUT",
                            headers: {
                                "Content-Type": "application/json"
                            },
                            body: JSON.stringify({
                                qualidadeRede: novaQualidade,
                                idMaquina: idMaquina
                            })
                        })
                            .then(() => {
                                // Recarregar a página após a atualização
                                setTimeout(() => qualidadeDaRede(), 2000);
                                // location.reload();
                            })
                            .catch(function (error) {
                                console.error("Erro ao atualizar a qualidade da rede:", error);
                            });
                    }
                // }, 5000);
            });
        }).catch(function (erro) {
            console.error("Erro na requisição fetch: ", erro);
        });
    }

    function mudarServidor() {
        idMaquina = Number(document.getElementById("listaServidor").value);
        atualizarDadosServidor();
    }

    function atualizarDadosServidor() {
            qualidadeDaRede();   // Atualiza a qualidade da rede
            listarIndicadores(); // Atualiza os indicadores
        iniciarGrafico();    // Reinicia o gráfico com os novos dados
    }

    //FUNÇÃO PARA LISTAR TODOS OS INDICADORES DE UMA DETERMINADA EMPRESA
    function listarIndicadores() {
        let op = document.getElementById("op");
        op.innerHTML = "";

        fetch(`rede/listarIndicadores/${idMaquina}`, {
            method: "GET",
            headers: {
                "Content-Type": "application/json"
            }
        }).then(function (resposta) {
            resposta.json().then(function (resposta) {
                resposta.forEach(element => {

                    let opcoes = document.createElement("div");
                    opcoes.className = "op";

                    // Adiciona as informações dentro das divs com a classe "opcoes"
                    let opcoesPP = document.createElement("div");
                    opcoesPP.className = "opcoes";
                    opcoesPP.innerHTML = `<h4>Pacotes Perdidos</h4><h5>${element.perdaPacotes || "N/A"}%</h5>`;
                    opcoes.appendChild(opcoesPP);

                    let opcoesLa = document.createElement("div");
                    opcoesLa.className = "opcoes";
                    opcoesLa.innerHTML = `<h4>Latência</h4><h5>${element.mediaLatencia || "N/A"}ms</h5>`;
                    opcoes.appendChild(opcoesLa);

                    let opcoesUp = document.createElement("div");
                    opcoesUp.className = "opcoes";
                    opcoesUp.innerHTML = `<h4>Mbps Upload</h4><h5>${element.mediaUpload || "N/A"}</h5>`;
                    opcoes.appendChild(opcoesUp);

                    let opcoesDw = document.createElement("div");
                    opcoesDw.className = "opcoes";
                    opcoesDw.innerHTML = `<h4>Mbps Download</h4><h5>${element.mediaDownload || "N/A"}</h5>`;
                    opcoes.appendChild(opcoesDw);

                    op.appendChild(opcoes);
                });
                setTimeout(() => listarIndicadores(), 2000);
            })
        }).catch(function (erro) {
            console.error("Erro na requisição fetch: ", erro);
        });
    }

    // LISTAR TODOS OS SERVIDORES
    function listarServidoresQualidade() {
        var fkEmpresa = sessionStorage.FK_EMPRESA;
        var lista = document.getElementById("lista");

        fetch(`rede/listar/${fkEmpresa}`, {
            method: "GET",
            headers: {
                "Content-Type": "application/json"
            }
        }).then(function (resposta) {
            resposta.json().then(function (resposta) {
                resposta.forEach(element => {
                    let serv = document.createElement("div");
                    serv.className = "serv";
                    serv.innerHTML = `<h4>${element.nomeMaquina}: </h4><h6>${element.qualidadeRede}</h6>`

                    lista.appendChild(serv);
                })
            })
        }).catch(function (resposta) {
            console.log(`#ERRO: ${resposta}`);
        });
    }

    // grafico de linha
    async function buscarDados() {
        try {
            const resposta = await fetch(`/rede/buscarTempoReal?idMaquina=${idMaquina}`);
            const json = await resposta.json();

            let dataEnviados = [];
            let dataRecebidos = [];
            let labels = [];

            json.forEach((element) => {
                if (element.idRecurso == 6) {
                    dataEnviados.push(element.registro);
                } else if (element.idRecurso == 7) {
                    dataRecebidos.push(element.registro);
                }
                if (!labels.includes(element.dtHora)) {
                    labels.push(element.dtHora); // Adicionar apenas horários únicos
                }
            });
            return { labels, dataEnviados, dataRecebidos };

        } catch (erro) {
            console.log("Erro ao buscar os dados:", erro);
            return { labels: [], dataEnviados: [], dataRecebidos: [] };
        }
    }

    async function plotarGrafico() {
        const { labels, dataEnviados, dataRecebidos } = await buscarDados();

        const ctx = document.getElementById('myChart').getContext('2d');
        const data = {
            labels: labels,
            datasets: [
                {
                    label: "Upload",
                    data: dataEnviados,
                    borderColor: 'rgba(68, 132, 184, 1)',
                    backgroundColor: 'rgba(68, 132, 184, 0.2)',
                    tension: 0.1,
                    borderWidth: 2,
                },
                {
                    label: "Download",
                    data: dataRecebidos,
                    borderColor: 'rgba(119, 58, 194, 1)',
                    backgroundColor: 'rgba(119, 58, 194, 0.2)',
                    tension: 0.1,
                    borderWidth: 2,
                }
            ],
        };

        const config = {
            type: 'line',
            data: data,
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'top',
                    },
                },
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Tempo',
                        },
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Mbps',
                        },
                    },
                },
            },
        };

        return new Chart(ctx, config);
    }

    async function atualizarDados(chart) {
        try {
            const { labels, dataEnviados, dataRecebidos } = await buscarDados();

            // Adicionar apenas novos dados para evitar duplicação
            labels.forEach((label, index) => {
                if (!chart.data.labels.includes(label)) {
                    chart.data.labels = labels;
                    chart.data.datasets[0].data = dataEnviados;
                    chart.data.datasets[1].data = dataRecebidos;
                }
            });

            // Atualizar o gráfico
            chart.update();

            // Reagendar a atualização (exemplo: a cada 5 segundos)
            setTimeout(() => atualizarDados(chart), 2000);
        } catch (erro) {
            console.log("Erro ao atualizar os dados:", erro);
        }
    }

    async function iniciarGrafico() {
        const chart = await plotarGrafico();
        atualizarDados(chart); // Inicia atualização automática
    }

</script>