<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | EyesAnalytic</title>

    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="../css/pages/dash-especialista.css">
    <!-- <link rel="stylesheet" href="../css/pages/espec-servidores.css"> -->
    <link rel="stylesheet" href="../css/pages/aside-menu.css">

    <link rel="stylesheet" href="./css/pages/lista-alertas.css">

    <link rel="shortcut icon" href="../assets/svg/Logo.svg" type="image/x-icon">
    <script src="../js/aside-menu.js"></script>
    <script src="../js/sessao.js"></script>
    <script type="text/javascript"> </script>
</head>

<body onload="validarSessao(), listarServidores()">
    <aside id="aside-menu">
        <img src="../assets/svg/Logo.svg" alt="Logo" class="asideLogo">

        <ul id="navLinks">

            <a href="../lista-alertas-especialista.html" class="outros">
                <li>
                    <img src="../assets/svg/alert-svgrepo-com.svg" alt="Alerta">
                    <span>Alertas</span>
                </li>
            </a>

            <a href="./dashboard/dash-especialista.html" class="outros">
                <li>
                    <img src="../assets/svg/dashboard-svgrepo-com.svg" alt="Dashboard">
                    <span>Dashboard</span>
                </li>
            </a>

            <a href="../dash-individual-luiz-especialista.html" class="outros">
                <li>
                    <img src="../assets/svg/icon-luiz.svg" alt="Rede">
                    <span>Componentes</span>
                </li>
            </a>

            <a href="../dash-rede.html" class="outros">
                <li>
                    <img src="../assets/svg/gauge.svg" alt="Dashboard">
                    <span>Rede</span>
                </li>
            </a>

            <a href="../dashboard/dash-especialista-seguranca.html" class="outros">
                <li>

                    <img src="../assets/svg/icon-gabriel.svg" alt="Segurança">

                    <span>Segurança</span>
                </li>
            </a>



            <a onclick="limparSessao()" class="outros">
                <li>
                    <img src="../assets/svg/exit-svgrepo-com.svg" alt="Saída">
                    <span>Sair</span>
                </li>
            </a>


        </ul>
        <div class="menu" id="menu-hamburguer">
            <div class="menu" id="menu-hamburguer">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" width="80px" height="10px"
                    class="hamburger-line">
                    <rect x="0" y="8" width="600" height="10" fill="white"></rect>
                </svg>

                <!-- Linha 2 -->
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" width="80px" height="10px"
                    class="hamburger-line">
                    <rect x="0" y="24" width="600" height="10" fill="white"></rect> <!-- Aumentar a altura aqui -->
                </svg>

                <!-- Linha 3 -->
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" width="80px" height="10px"
                    class="hamburger-line">
                    <rect x="0" y="40" width="600" height="10" fill="white"></rect> <!-- Aumentar a altura aqui -->
                </svg>
            </div>

        </div>

        </div>
    </aside>
    <div id="fade" class="hide"></div>

    <main class="main-dash">
        <!-- <header class="header-dash"> -->

        <!-- </header> -->
        <div class="content-main">

            <div class="topo">

                <section class="kpi">
                    <div class="informacao">
                        <div class="title"><b>Indicadores</b></div>
                        <div class="tooltip-container">
                            <i class="fas fa-info-circle" id="infoIcon"></i> <!-- Ícone de informação -->
                            <div class="tooltip-box" id="msgBox">
                                <span class="tooltip-message">Indicadores dos componentes do servidor selecionado. CPU e RAM em percentual (%) e Pacotes Recebidos e Pacotes Enviados em "kb" (KiloBtyes)
                                </span>
                            </div>
                        </div>
                    </div>
                    <div class="quadro" id="indicadoresQuadro">
                        <!-- Indicadores serão inseridos aqui dinamicamente -->
                    </div>
                </section>



                <section class="serv">
                    
                    <div class="informacao">
                        <div class="title"><b>Servidores</b></div>
                        <div class="tooltip-container">
                            <i class="fas fa-info-circle" id="infoIcon"></i> <!-- Ícone de informação -->
                            <div class="tooltip-box" id="msgBox">
                                <span class="tooltip-message">Servidores listados pela empresa
                                </span>
                            </div>
                        </div>
                    </div>
                    <div class="dados-section">
                        <article class="card-section" id="lista">
                        </article>
                        <div id="modal" class="modal">
                        </div>
                    </div>

                </section>

            </div>


            <section class="grafico-section">
                <div class="informacao">
                    <div class="title1"><b>Gráficos de uso em porcentagem (%)</b></div>
                    <div class="tooltip-container">
                        <i class="fas fa-info-circle" id="infoIcon"></i> <!-- Ícone de informação -->
                        <div class="tooltip-box" id="msgBox">
                            <span class="tooltip-message">Gráficos de CPU e RAM em tempo real exibindo captura a cada 1 minuto.
                            </span>
                        </div>
                    </div>
                </div>
                <div class="graf">
                    <div class="graf-titu">
                        <h3>CPU</h3>
                        
                            <canvas id="CpuChart" style="position: relative; height:15vh; width:10vw"></canvas>

                        
                    </div>
                    <div class="graf-titu">
                        <h3>RAM</h3>
                        
                            <canvas id="RamChart" style="position: relative; height:15vh; width:10vw"></canvas>
                        
                    </div>
                </div>
            </section>

    </main>

</body>

</html>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
<script>

    var charts = []
    var idMaquina
    var intervalo = 1000

    async function buscarDados(idRecurso) {
        try {
            const resposta = await fetch(`/capturas/buscarTempoReal?idMaquina=${idMaquina}&idRecurso=${idRecurso}`)

            const json = await resposta.json()

            let data = []
            let labels = []

            json.forEach(element => {
                data.push(element.registro)
                labels.push(element.dtHora)
            })
            return {
                data: data,
                labels: labels
            }
        } catch (erro) {
            console.log(erro)
            return { data: [], labels: [] }
        }
    }



    async function plotarGrafico(idRecurso) {
        const resposta = await buscarDados(idRecurso);

        const labels = Object.values(resposta.labels);
        const dados = Object.values(resposta.data);

        let ctx;
        let label;

        if (idRecurso == 1) {
            ctx = document.getElementById('CpuChart').getContext('2d');
            label = "Uso CPU (%)";
        }
        if (idRecurso == 2) {
            ctx = document.getElementById('RamChart').getContext('2d');
            label = "Uso RAM (%)";
        }

        let data = {
            labels: labels,
            datasets: [{
                label: label,
                data: dados,
                borderColor: 'rgba(75, 192, 192, 1)',
                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                borderWidth: 1
            }]

        };

        const config = {
            type: 'line', // Escolha o tipo de gráfico, como 'line', 'bar', etc.
            data: data,
            options: {
                responsive: false,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        };

        const chart = new Chart(ctx, config);

        charts.push(chart)
        setTimeout(function () {
            atualizarDados(chart, idRecurso)
        }, intervalo)



    }

    async function atualizarDados(chart, idRecurso, delay = intervalo) {
        try {
            var dados
            var labels
            const resposta = await buscarDados(idRecurso)
            dados = Object.values(resposta.data);
            labels = Object.values(resposta.labels);

            console.log(dados)

            atualizarGrafico(chart, dados, labels)
            setTimeout(function () {
                atualizarDados(chart, idRecurso)
            }, delay)


        }
        catch (erro) {
            console.log(erro)
        }

        function atualizarGrafico(chart, dados, labels) {
            chart.data.datasets[0].data.shift()
            chart.data.datasets[0].data = dados
            chart.data.labels.shift()
            chart.data.labels = labels
            chart.update()
        }
    }

    function atualizarDash(Maquinaid) {
        idMaquina = Maquinaid

    }


    function iniciarGrafico() {
        plotarGrafico(1)
        plotarGrafico(2)
    }


    // Variável global para armazenar o id da máquina selecionada
    let idMaquinaSelecionada = null;

    // FUNÇÃO PARA LISTAR TODOS OS SERVIDORES DE UMA DETERMINADA EMPRESA
    function listarServidores() {
        var fkEmpresa = sessionStorage.FK_EMPRESA;
        var lista = document.getElementById("lista");

        fetch(`/servidor/listar/${fkEmpresa}`, {
            method: "GET",
            headers: {
                "Content-Type": "application/json"
            }
        }).then(function (resposta) {
            resposta.json().then(function (resposta) {
                resposta.forEach(element => {
                    let openModal = document.createElement("div");
                    openModal.className = "openModal";

                    let frameAlertas = document.createElement("div");
                    frameAlertas.className = "frameAlertas";

                    let abrir = document.createElement("div");
                    abrir.className = "abrir";
                    abrir.id = "openModal";

                    // Passa o idMaquina e o IP para a função atualizarIndicadores ao clicar
                    abrir.onclick = function () {
                        atualizarDash(element.idMaquina);
                        idMaquinaSelecionada = element.idMaquina;  // Atualiza a variável global com o id da máquina selecionada
                        atualizarIndicadores(idMaquinaSelecionada, element.IP); // Chama a função passando o id e o IP
                    };

                    let titulo = document.createElement("h3");
                    titulo.innerText = element.nomeMaquina;


                    // Montando o conteúdo do modal
                    abrir.appendChild(titulo);
                    // abrir.appendChild(opcoes);
                    frameAlertas.appendChild(abrir);

                    openModal.appendChild(frameAlertas);

                    // Adicionando o modal completo ao DOM
                    lista.appendChild(openModal);
                });

                // Chama a função iniciarGrafico se necessário
                idMaquinaSelecionada = resposta[0].idMaquina;
                iniciarGrafico();
                iniciarAtualizacaoIndicadores();
            });
        });
    }


    //FUNÇÃO PARA LISTAR INFORMAÇÕES DE UM SERVIDOR ESPECIFICO
    function listarEspecifico() {
        fetch(`servidor/listarEspecifico/${idMaquina}`, {
            method: "GET",
            headers: {
                "Content-Type": "application/json"
            }
        }).then(function (resposta) {
            resposta.json().then(function (resposta) {
                // Monta o conteúdo que será exibido no alerta
                let atributosTexto = ''; // Para armazenar os atributos formatados

                // Itera sobre os elementos da resposta para formatar os atributos
                resposta.forEach(element => {
                    atributosTexto += `<b>${element.nomeAtributo}</b>: ${element.valorAtributo} (<b>${element.nomeRecurso}</b>) <br>`;

                    // Exibe um único alerta com todos os atributos da máquina
                    Swal.fire({
                        title: element.nomeMaquina,  // Mostra o nome da máquina
                        html: `<div style="text-align: justify; justify-content: center; padding-left:100px">
                                    ${atributosTexto}
                                    </div> 
                                <div>
                                <br><b>Prioridade:</b> 
                                    ${resposta[0].nivelPrioridade} 
                                <br>
                                <b>Situação:</b> <span style="color:#08836A; font-weight: 600" >
                                    ${resposta[0].situacao}</span>
                                 </div>`,  // Exibe a prioridade
                        showCancelButton: true,
                        cancelButtonColor: "#05a65d",
                        showConfirmButton: false,
                        cancelButtonText: "Ok"
                    });
                });

                // Após mostrar o alerta, chama a função para atualizar os indicadores
                atualizarIndicadores();
            })
        }).catch(function () {
            Swal.fire({
                title: "Erro!",
                text: "Houve um erro em listar informações o servidor.",
                icon: "error",
                confirmButtonColor: "#05a65d"
            });
        })
    }

    // Função para atualizar os indicadores periodicamente
    function iniciarAtualizacaoIndicadores() {
        // Atualiza os indicadores imediatamente na primeira execução
        atualizarIndicadores();

        // Define um intervalo para atualizar os indicadores a cada 30 segundos (30000 ms)
        setInterval(() => {
            atualizarIndicadores();
        }, 30000);
    }


    function listarEspecifico(idMaquina) {
        fetch(`servidor/listarEspecifico/${idMaquina}`, {
            method: "GET",
            headers: {
                "Content-Type": "application/json"
            }
        })
            .then((resposta) => {
                if (!resposta.ok) {
                    throw new Error("Erro ao listar servidor específico");
                }
                return resposta.json();
            })
            .then((resposta) => {
                let atributosTexto = ""; // Para armazenar os atributos formatados

                resposta.forEach((element) => {
                    atributosTexto += `<b>${element.nomeAtributo}</b>: ${element.valorAtributo} (<b>${element.nomeRecurso}</b>) <br>`;
                });

                // Exibe os dados detalhados em um alerta
                Swal.fire({
                    title: resposta[0].nomeMaquina,  // Mostra o nome da máquina
                    html: `<div style="text-align: justify; justify-content: center; padding-left:100px">
                            ${atributosTexto}
                        </div> 
                        <div>
                        <br><b>Prioridade:</b> 
                            ${resposta[0].nivelPrioridade} 
                        <br>
                        <b>Situação:</b> <span style="color:#08836A; font-weight: 600" >
                            ${resposta[0].situacao}</span>
                         </div>`,  // Exibe a prioridade
                    showCancelButton: true,
                    cancelButtonColor: "#05a65d",
                    showConfirmButton: false,
                    cancelButtonText: "Ok"
                });

                // Após mostrar o alerta, chama a função para atualizar os indicadores
                atualizarIndicadores();
            })
            .catch(() => {
                Swal.fire({
                    title: "Erro!",
                    text: "Houve um erro ao listar as informações do servidor.",
                    icon: "error",
                    confirmButtonColor: "#05a65d"
                });
            });
    }

    // Função para atualizar os indicadores, agora com o parâmetro IP
    function atualizarIndicadores() {
        let quadroIndicadores = document.getElementById("indicadoresQuadro");
        quadroIndicadores.innerHTML = ""; // Limpa o quadro antes de adicionar os novos indicadores

        // Substitua a URL com a rota correta para obter os indicadores do servidor
        fetch(`/servidor/indicadores/${idMaquina}`, {
            method: "GET",
            headers: {
                "Content-Type": "application/json"
            }
        })
            .then(function (resposta) {
                if (!resposta.ok) {
                    throw new Error("Erro na resposta do servidor");
                }
                return resposta.json();
            })
            .then(function (dados) {
                if (dados.length > 0) {



                    // Cria e insere os elementos para cada indicador (CPU, RAM, Download, Upload)
                    let indicadores = [
                        { nome: "CPU", valor: dados[0].CPU.toFixed(2), sufixo: "%" },
                        { nome: "RAM", valor: dados[0].RAM.toFixed(2), sufixo: "%" },
                        {
                            nome: "Recebidos",
                            valor:dados[0].Download.toFixed(2), // Converte MB para KB e arredonda
                            sufixo: "KB"
                        },
                        {
                            nome: "Enviados",
                            valor: dados[0].Upload.toFixed(2), // Converte MB para KB e arredonda
                            sufixo: "KB"
                        }
                    ];


                    indicadores.forEach(indicador => {
                        // Criar o elemento do indicador
                        let divIndicador = document.createElement("div");
                        divIndicador.classList.add("indica"); // Nome da classe no HTML corrigida para "indica"

                        // Criar o título do indicador
                        let nomeIndicador = document.createElement("h3");
                        nomeIndicador.textContent = indicador.nome; // Evita problemas de segurança com innerHTML

                        // Criar o valor do indicador com sufixo
                        let valorIndicador = document.createElement("p");
                        // Verifica se o valor é válido, e adiciona o sufixo
                        valorIndicador.textContent = indicador.valor ? `${indicador.valor} ${indicador.sufixo}` : "N/A"; // Valor padrão com sufixo

                        // Adicionar o título e o valor ao contêiner do indicador
                        divIndicador.appendChild(nomeIndicador);
                        divIndicador.appendChild(valorIndicador);

                        // Adicionar o indicador ao quadro
                        quadroIndicadores.appendChild(divIndicador);
                    });

                } else {
                    quadroIndicadores.innerHTML = "<p>Nenhum dado selecionado / encontrado</p>";
                }
            })
            .catch(function (erro) {
                console.error("Erro ao buscar indicadores:", erro);
                quadroIndicadores.innerHTML = "<p>Erro ao carregar os dados / Nenhum dado selecionado</p>";
            });
    }








</script>