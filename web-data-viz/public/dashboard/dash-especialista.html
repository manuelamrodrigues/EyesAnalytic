<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | EyesAnalytic</title>
    <link rel="stylesheet" href="../css/pages/dash-especialista.css">
    <!-- <link rel="stylesheet" href="../css/pages/espec-servidores.css"> -->
    <link rel="stylesheet" href="../css/pages/aside-menu.css">
    <link rel="stylesheet" href="./css/pages/lista-alertas.css">
    <link rel="shortcut icon" href="../assets/svg/Logo.svg" type="image/x-icon">
    <script src="../js/aside-menu.js"></script>
    <script src="../js/sessao.js"></script>
</head>

<body onload="validarSessao(), listarServidores()">
    <aside id="aside-menu">
        <img src="../assets/svg/Logo.svg" alt="Logo" class="asideLogo">

        <ul id="navLinks">

            <a href="../lista-alertas-especialista.html" class="outros">
                <li>
                    <img src="../assets/svg/alert-svgrepo-com.svg" alt="Alerta">
                    <span>Alertas</span>
                </li>
            </a>

            <a href="./dash-especialista.html" class="outros">
                <li>
                    <img src="../assets/svg/dashboard-svgrepo-com.svg" alt="Dashboard">
                    <span>Dashboard</span>
                </li>
            </a>

            <!-- <a href="../abrir-chamado.html" class="outros">
                <li>
                    <img src="../assets/svg/speed-svgrepo-com.svg" alt="Rede">
                    <span>Rede</span>
                </li>
            </a> -->

            <!-- <a href="../abrir-chamado.html" class="outros">
                <li>
                    <img src="../assets/svg/user-svgrepo-com.svg" alt="Usuário">
                    <span>Funcionários</span>
                </li>
            </a> -->

            <!-- <a href="../chamados-especialista.html" class="outros">
                <li>
                    <img src="../assets/svg/chamados.svg" alt="Chamados">
                    <span>Chamados</span>
                </li>
            </a> 
        -->
            <a onclick="limparSessao()" class="outros">
                <li>
                    <img src="../assets/svg/exit-svgrepo-com.svg" alt="Saída">
                    <span>Sair</span>
                </li>
            </a>

        </ul>
        <div class="menu" id="menu-hamburguer">
            <div class="menu" id="menu-hamburguer">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" width="80px" height="10px"
                    class="hamburger-line">
                    <rect x="0" y="8" width="600" height="10" fill="white"></rect>
                </svg>

                <!-- Linha 2 -->
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" width="80px" height="10px"
                    class="hamburger-line">
                    <rect x="0" y="24" width="600" height="10" fill="white"></rect> <!-- Aumentar a altura aqui -->
                </svg>

                <!-- Linha 3 -->
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" width="80px" height="10px"
                    class="hamburger-line">
                    <rect x="0" y="40" width="600" height="10" fill="white"></rect> <!-- Aumentar a altura aqui -->
                </svg>
            </div>

        </div>

        </div>
    </aside>
    <div id="fade" class="hide"></div>

    <main class="main-dash">
        <header class="header-dash">
            
        </header>
        <div class="content-main">
            <section class="grafico-section">
                <h2>Gráficos de uso em porcentagem (%)</h2>
                <h3>CPU</h3>
                <canvas id="CpuChart" style="position: relative; height:15vh; width:10vw"></canvas>
                <h3>RAM</h3>
                <canvas id="RamChart" style="position: relative; height:15vh; width:10vw"></canvas>
            </section>
            <section class="dados-section">
                <h2>Servidores</h2>
                <article class="card-section" id="lista">

                </article>
                <div id="modal" class="modal">
                </div>
                
            </section>

    </main>

</body>

</html>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
<script>

    var charts = []
    var idMaquina
    var intervalo = 1000

    async function buscarDados(idRecurso) {
        try {
            const resposta = await fetch(`/capturas/buscarTempoReal?idMaquina=${idMaquina}&idRecurso=${idRecurso}`)

            const json = await resposta.json()

            let data = []
            let labels = []

            json.forEach(element => {
                data.push(element.registro)
                labels.push(element.dtHora)
            })
            return {
                data: data,
                labels: labels
            }
        } catch (erro) {
            console.log(erro)
            return { data: [], labels: [] }
        }
    }



    async function plotarGrafico(idRecurso) {
        const resposta = await buscarDados(idRecurso);

        const labels = Object.values(resposta.labels);
        const dados = Object.values(resposta.data);

        let ctx;
        let label;

        if (idRecurso == 1) {
            ctx = document.getElementById('CpuChart').getContext('2d');
            label = "Uso CPU (%)";
        }
        if (idRecurso == 2) {
            ctx = document.getElementById('RamChart').getContext('2d');
            label = "Uso RAM (%)";
        }

        let data = {
            labels: labels,
            datasets: [{
                label: label,
                data: dados,
                borderColor: 'rgba(75, 192, 192, 1)',
                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                borderWidth: 1
            }]

        };

        const config = {
            type: 'line', // Escolha o tipo de gráfico, como 'line', 'bar', etc.
            data: data,
            options: {
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        };

        const chart = new Chart(ctx, config);

        charts.push(chart)
        setTimeout(function () {
            atualizarDados(chart, idRecurso)
        }, intervalo)



    }

    async function atualizarDados(chart, idRecurso, delay = intervalo) {
        try {
            var dados
            var labels
            const resposta = await buscarDados(idRecurso)
            dados = Object.values(resposta.data);
            labels = Object.values(resposta.labels);

            console.log(dados)

            atualizarGrafico(chart, dados, labels)
            setTimeout(function () {
                atualizarDados(chart, idRecurso)
            }, delay)


        }
        catch (erro) {
            console.log(erro)
        }

        function atualizarGrafico(chart, dados, labels) {
            chart.data.datasets[0].data.shift()
            chart.data.datasets[0].data = dados
            chart.data.labels.shift()
            chart.data.labels = labels
            chart.update()
        }
    }

    function atualizarDash(Maquinaid) {
        idMaquina = Maquinaid

    }


    function iniciarGrafico() {
        plotarGrafico(1)
        plotarGrafico(2)
    }

    //FUNÇÃO PARA LISTAR TODOS OS SERVIDORES DE UMA DETERMINADA EMPRESA
    function listarServidores() {
        var fkEmpresa = sessionStorage.FK_EMPRESA;

        var lista = document.getElementById("lista");
        fetch(`/servidor/listar/${fkEmpresa}`, {
            method: "GET",
            headers: {
                "Content-Type": "application/json"
            }
        }).then(function (resposta) {
            resposta.json().then(function (resposta) {
                resposta.forEach(element => {
                    let openModal = document.createElement("div");
                    openModal.className = "openModal";

                    let frameAlertas = document.createElement("div");
                    frameAlertas.className = "frameAlertas";

                    let abrir = document.createElement("div");
                    abrir.className = "abrir";
                    abrir.id = "openModal";
                    abrir.onclick = function () {
                        atualizarDash(element.idMaquina)
                    };

                    let titulo = document.createElement("h3");
                    titulo.innerText = element.nomeMaquina;

                    // Adicionando opções de CPU, Memória e Disco
                    let opcoes = document.createElement("div");
                    opcoes.className = "opcoes";

                    // CPU
                    let opcaoCPU = document.createElement("div");
                    opcaoCPU.className = "opcao";
                    opcaoCPU.innerHTML = "<h4>CPU:</h4><p>" + (element.CPU || "N/A") + "%</p>";

                    // Memória
                    let opcaoMemoria = document.createElement("div");
                    opcaoMemoria.className = "opcao";
                    opcaoMemoria.innerHTML = "<h4>Memória:</h4><p>" + (element.Memoria || "N/A") + "%</p>";

                    // Disco
                    let opcaoDisco = document.createElement("div");
                    opcaoDisco.className = "opcao";
                    opcaoDisco.innerHTML = "<h4>Disco:</h4><p>" + (element.Disco || "N/A") + "%</p>";

                    // Adicionando opções à div 'opcoes'
                    opcoes.appendChild(opcaoCPU);
                    opcoes.appendChild(opcaoMemoria);
                    opcoes.appendChild(opcaoDisco);

                    // Montando o conteúdo do modal
                    abrir.appendChild(titulo);
                    abrir.appendChild(opcoes);
                    frameAlertas.appendChild(abrir);

                    openModal.appendChild(frameAlertas);

                    // Adicionando o modal completo ao DOM
                    lista.appendChild(openModal);

                });
                idMaquina = resposta[0].idMaquina
                iniciarGrafico()
            });
        })
    }

    //FUNÇÃO PARA LISTAR INFORMAÇÕES DE UM SERVIDOR ESPECIFICO
    function listarEspecifico(idMaquina) {
        fetch(`servidor/listarEspecifico/${idMaquina}`, {
            method: "GET",
            headers: {
                "Content-Type": "application/json"
            }
        }).then(function (resposta) {
            resposta.json().then(function (resposta) {
                // Monta o conteúdo que será exibido no alerta
                let atributosTexto = ''; // Para armazenar os atributos formatados

                // Itera sobre os elementos da resposta para formatar os atributos
                resposta.forEach(element => {
                    atributosTexto += `<b>${element.nomeAtributo}</b>: ${element.valorAtributo} (<b>${element.nomeRecurso}</b>) <br>`;

                    // Exibe um único alerta com todos os atributos da máquina
                    Swal.fire({
                        title: element.nomeMaquina,  // Mostra o nome da máquina
                        html: `<div style="text-align: justify; justify-content: center; padding-left:100px">
                                    ${atributosTexto}
                                    </div> 
                                <div>
                                <br><b>Prioridade:</b> 
                                    ${resposta[0].nivelPrioridade} 
                                <br>
                                <b>Situação:</b> <span style="color:#08836A; font-weight: 600" >
                                    ${resposta[0].situacao}</span>
                                 </div>`,  // Exibe a prioridade
                        showCancelButton: true,
                        cancelButtonColor: "#05a65d",
                        showConfirmButton: false,
                        cancelButtonText: "Ok"
                    });
                });
            })
        }).catch(function () {
            Swal.fire({
                title: "Erro!",
                text: "Houve um erro em listar informações o servidor.",
                icon: "error",
                confirmButtonColor: "#05a65d"
            });
        })
    }

</script>