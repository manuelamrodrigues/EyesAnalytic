<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chamados | EyesAnalytic</title>
    <link rel="stylesheet" href="css/pages/chamado-diretor.css">
    <link rel="stylesheet" href="css/pages/aside-menu.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="shortcut icon" href="./assets/svg/Logo.svg" type="image/x-icon">

</head>

<body onload="listarChamados()">

    <aside id="aside-menu">
        <img src="./assets/svg/Logo.svg" alt="Logo" class="asideLogo">

        <ul id="navLinks">
            <a href="./lista-alertas.html" class="outros">
                <li>
                    <img src="./assets/svg/alert-svgrepo-com.svg" alt="Alerta">
                    <span>Alertas</span>
                </li>
            </a>

            <a href="./dashboard/dash-diretor.html" class="outros">
                <li>
                    <img src="./assets/svg/dashboard-svgrepo-com.svg" alt="Dashboard">
                    <span>Dashboard</span>
                </li>
            </a>

            <a href="./espec-servidores.html" class="outros">
                <li>
                    <img src="./assets/svg/servidor.svg" alt="Rede">
                    <span>Sevidores</span>
                </li>
            </a>

            <a href="./funcionario-diretor.html" class="outros">
                <li>
                    <img src="./assets/svg/user-svgrepo-com.svg" alt="Usuário">
                    <span>Funcionários</span>
                </li>
            </a>

            <a href="./chamados-diretor.html" class="outros">
                <li>
                    <img src="./assets/svg/chamados.svg" alt="Chamados">
                    <span>Chamados</span>
                </li>
            </a>

            <a href="./index.html" class="outros">
                <li>
                    <img src="./assets/svg/exit-svgrepo-com.svg" alt="Saída">
                    <span>Sair</span>
                </li>
            </a>

        </ul>
        <div class="menu" id="menu-hamburguer">
            <div class="menu" id="menu-hamburguer">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" width="80px" height="10px"
                    class="hamburger-line">
                    <rect x="0" y="8" width="600" height="10" fill="white"></rect> <!-- Aumentar a altura aqui -->
                </svg>

                <!-- Linha 2 -->
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" width="80px" height="10px"
                    class="hamburger-line">
                    <rect x="0" y="24" width="600" height="10" fill="white"></rect> <!-- Aumentar a altura aqui -->
                </svg>

                <!-- Linha 3 -->
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" width="80px" height="10px"
                    class="hamburger-line">
                    <rect x="0" y="40" width="600" height="10" fill="white"></rect> <!-- Aumentar a altura aqui -->
                </svg>
            </div>

        </div>

        </div>
    </aside>
    <div id="fade" class="hide"></div>


    <main>
        <section class="title">
            <h1>Meus Chamados</h1>
            <a href="./abrir-chamado.html"><button>Abrir Chamado</button> </a>
        </section>

        <section class="chamados" id="chamados">
            <!-- <section class="chamado">
                <article class="cabecalhoChamado">
                    <div class="informacoesChamado">
    
                        <img src="assets/imgs/alerta.png" alt="">
    
                        <div class="separacaoInformacoes">
                            <p>Responsável: </p>
                            <p class="negrito">Fernando Silva</p>
                        </div>
    
                        <div class="separacaoInformacoes2">
                            <p>Status: </p>
                            <p>Não atendido</p>
                        </div>
    
                        <div class="separacaoInformacoes3">
                            <p>Urgência: </p>
                            <p>Leve</p>
                        </div>
    
                    </div>
                    <div class="dadosChamado">
                        <div class="sobreChamado">
                            <p>15:30</p>
                            <p>22/09/2024</p>
                        </div>
    
                        <button>Cancelar Chamado</button>
                    </div>
    
                </article>
    
                <article class="fundoChamado">
                    <p  class="tituloChamado">Alto uso de CPU</p>
                    <div class="textoChamado">
                        <p>Descrição: O uso da CPU está muito elevado, vá investigar! </p>
                    </div>
                </article>
            </section>

            <section class="chamado">
                <article class="cabecalhoChamado">
                    <div class="informacoesChamado">
    
                        <img src="assets/imgs/alerta.png" alt="">
    
                        <div class="separacaoInformacoes">
                            <p>Responsável: </p>
                            <p class="negrito">Fernando Silva</p>
                        </div>
    
                        <div class="separacaoInformacoes2">
                            <p>Status: </p>
                            <p>Atendido</p>
                        </div>
    
                        <div class="separacaoInformacoes3">
                            <p>Urgência: </p>
                            <p>Leve</p>
                        </div>
    
                    </div>
                    <div class="dadosChamado">
                        <div class="sobreChamado">
                            <p>15:30</p>
                            <p>22/09/2024</p>
                        </div>
    
                       
                    </div>
    
                </article>
    
                <article class="fundoChamado">
                    <p  class="tituloChamado">Alto uso de CPU</p>
                    <div class="textoChamado">
                        <p>Descrição: O uso da CPU está muito elevado, vá investigar! </p>
                    </div>
                </article>
            </section>
            
            <section class="chamado">
                <article class="cabecalhoChamado">
                    <div class="informacoesChamado">
    
                        <img src="assets/imgs/alerta.png" alt="">
    
                        <div class="separacaoInformacoes">
                            <p>Responsável: </p>
                            <p class="negrito">Fernando Silva</p>
                        </div>
    
                        <div class="separacaoInformacoes2">
                            <p>Status: </p>
                            <p>Atendido</p>
                        </div>
    
                        <div class="separacaoInformacoes3">
                            <p>Urgência: </p>
                            <p>Leve</p>
                        </div>
    
                    </div>
                    <div class="dadosChamado">
                        <div class="sobreChamado">
                            <p>15:30</p>
                            <p>22/09/2024</p>
                        </div>
    
                    </div>
    
                </article>
    
                <article class="fundoChamado">
                    <p class="tituloChamado">Alto uso de CPU</p>
                    <div class="textoChamado">
                        <p>Descrição: O uso da CPU está muito elevado, vá investigar! </p>
                    </div>
                </article>
            </section> -->

        </section>
    </main>



</body>

</html>

<script>
    function listarChamados() {
        var dataAtual = new Date()
        var chamados = document.getElementById("chamados")
        var idDiretor = sessionStorage.ID_USUARIO
        fetch('/chamados/listarPorDiretor', {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({
                idDiretor: idDiretor
            })
        }).then(function (resposta) {
            resposta.json().then(function (resposta) {
                console.log("Dados encontrados:", resposta)
                resposta.forEach(element => {
                    var base = document.getElementById("chamados")
                    var data = new Date(element.dtHora)
                    var dataDia = data.getDate()
                    var dataMes = data.getMonth()
                    var dataAno = data.getFullYear()
                    var dataHoras = data.getHours()
                    var dataMinutos = data.getMinutes()
                    var horas = `${adicionarZero(dataHoras)}:${adicionarZero(dataMinutos)}`
                    var date = `${adicionarZero(dataDia)}/${adicionarZero(dataMes)}/${adicionarZero(dataAno)}`


                    var chamado = document.createElement("section")
                    var cabecalhoChamado = document.createElement("article")
                    var informacoesChamado = document.createElement("div")
                    var separacaoInformacoes = document.createElement("div")
                    var diretor = document.createElement("p")
                    var respostaDiretor = document.createElement("p")
                    var separacaoInformacoes2 = document.createElement("div")
                    var status = document.createElement("p")
                    var respostaStatus = document.createElement("p")
                    var separacaoInformacoes3 = document.createElement("div")
                    var urgencia = document.createElement("p")
                    var respostaUrgencia = document.createElement("p")
                    var dadosChamado = document.createElement("div")
                    var sobreChamado = document.createElement("div")
                    var hora = document.createElement("p")
                    var data = document.createElement("p")
                    var cancelarchamado = document.createElement("div")
                    cancelarchamado.innerHTML = `<button onclick='cancelarChamado(${element.idChamado})'>Cancelar Chamado</button>`

                    var fundoChamado = document.createElement("article")
                    var tituloChamado = document.createElement("p")
                    var textoChamado = document.createElement("div")
                    var texto = document.createElement("p")

                    base.appendChild(chamado)
                    chamado.className = "chamado"
                    chamado.appendChild(cabecalhoChamado)
                    chamado.appendChild(fundoChamado)

                    cabecalhoChamado.className = "cabecalhoChamado"
                    cabecalhoChamado.appendChild(informacoesChamado)
                    cabecalhoChamado.appendChild(dadosChamado)


                    informacoesChamado.className = "informacoesChamado"


                    informacoesChamado.appendChild(separacaoInformacoes2)


                    separacaoInformacoes2.className = "separacaoInformacoes2"
                    separacaoInformacoes2.appendChild(status)
                    status.innerHTML = "Status: "
                    separacaoInformacoes2.appendChild(respostaStatus)
                    respostaStatus.innerHTML = element.situacao
                    if (element.situacao == "Não Atendido") {
                        respostaStatus.style.color = "Yellow"
                    }
                    if (element.situacao == "Atendido") {
                        respostaStatus.style.color = "lightgreen"
                    }
                    if (element.situacao == "Cancelado") {
                        respostaStatus.style.color = "Red"
                    }

                    informacoesChamado.appendChild(separacaoInformacoes3)

                    separacaoInformacoes3.className = 'separacaoInformacoes3'
                    separacaoInformacoes3.appendChild(urgencia)
                    urgencia.innerHTML = "Urgência: "
                    separacaoInformacoes3.appendChild(respostaUrgencia)
                    respostaUrgencia.innerHTML = element.urgencia
                    if (element.urgencia == "alta") {
                        respostaUrgencia.style.color = "Red"
                    }
                    if (element.urgencia == "média") {
                        respostaUrgencia.style.color = "Yellow"
                    }

                    informacoesChamado.appendChild(separacaoInformacoes)
                    separacaoInformacoes.className = "separacaoInformacoes"
                    separacaoInformacoes.appendChild(diretor)
                    separacaoInformacoes.appendChild(respostaDiretor)
                    diretor.innerHTML = "Responsável: "
                    respostaDiretor.innerHTML = element.NomeEspecialista

                    dadosChamado.className = 'dadosChamado'
                    dadosChamado.appendChild(sobreChamado)

                    sobreChamado.className = 'sobreChamado'
                    sobreChamado.appendChild(hora)
                    hora.innerHTML = horas
                    sobreChamado.appendChild(data)
                    data.innerHTML = date
                    dadosChamado.appendChild(cancelarchamado)


                    fundoChamado.className = 'fundoChamado'
                    fundoChamado.appendChild(tituloChamado)

                    tituloChamado.className = 'tituloChamado'
                    tituloChamado.innerHTML = element.assunto
                    fundoChamado.appendChild(textoChamado)
                    textoChamado.className = 'textoChamado'
                    textoChamado.appendChild(texto)
                    texto.innerHTML = element.descricao

                }
                );
            })
        })
            .catch(function (error) {
                console.log("#ERROR:", error)
            })
    }
    function adicionarZero(numero) {
        return (numero < 10 ? '0' : '') + numero;
    }

    function cancelarChamado(idChamado) {
        fetch("chamados/buscarPorId", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({
                idChamado: idChamado
            })
        })
            .then(function (resposta) {
                console.log(resposta)
                if (resposta.ok) {
                    fetch("chamados/cancelar", {
                        method: "PUT",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify({
                            idChamado: idChamado
                        })
                    }).then(function (resultado) {
                        if (resultado.ok) {
                            Swal.fire({
                                title: "Chamado Alterado para cancelado!",
                                text: "Espere um pouco...",
                                icon: "success",
                                confirmButtonColor: '#4CAF50', // Cor vermelha do botão
                                timer: 2000, // Tempo antes de fechar automaticamente
                                timerProgressBar: true
                            }).then(() => {
                                location.reload(); // Recarregar a página após o alerta
                            });
                            // alert("Chamado Alterado para cancelado! Espere um pouco...")
                            // setTimeout(() => {
                            //     location.reload()
                            // }, 2000)
                        }
                        else {
                            Swal.fire({
                                title: "Erro ao atualizar situação!",
                                // text: "Espere um pouco...",
                                icon: "error",
                                confirmButtonColor: "#bd0023", // Cor vermelha do botão
                                // timer: 2000, // Tempo antes de fechar automaticamente
                                // timerProgressBar: true
                            })
                            // alert("Erro ao atualizar situação!")
                        }
                    })
                }
                if (resposta.status == 204) {
                    console.log("Não foi encontrado nenhum chamado com esse id")
                }
            })
            .catch(
                function (error) {
                    console.log("#ERRO:", error)
                }
            )
    }
</script>