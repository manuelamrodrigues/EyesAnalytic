<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | EyesAnalytic</title>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <link rel="stylesheet" href="./css/pages/dash-individual-luiz-especialista.css">
    <link rel="stylesheet" href="./css/pages/aside-menu.css">
    <script src="./js/aside-menu.js"></script>
    <link rel="shortcut icon" href="./assets/svg/Logo.svg" type="image/x-icon">
    <script src="./js/sessao.js"></script>

</head>

<body onabort=" iniciarAtualizacao()" onload="validarSessao()">

    <aside id="aside-menu">
        <img src="./assets/svg/Logo.svg" alt="Logo" class="asideLogo">

        <ul id="navLinks">

            <a href="./lista-alertas-especialista.html" class="outros">
                <li>
                    <img src="./assets/svg/alert-svgrepo-com.svg" alt="Alerta">
                    <span>Alertas</span>
                </li>
            </a>

            <a href="./dash-diretor.html" class="outros">
                <li>
                    <img src="./assets/svg/dashboard-svgrepo-com.svg" alt="Dashboard">
                    <span>Dashboard</span>
                </li>
            </a>

            <a href="./espec-servidores.html" class="outros">
                <li>
                    <img src="./assets/svg/icon-luiz.svg" alt="Rede">
                    <span>Componentes</span>
                </li>
            </a>



            <a onclick="limparSessao()" class="outros">
                <li>
                    <img src="./assets/svg/exit-svgrepo-com.svg" alt="Saída">
                    <span>Sair</span>
                </li>
            </a>

        </ul>
        <div class="menu" id="menu-hamburguer">
            <div class="menu" id="menu-hamburguer">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" width="80px" height="10px"
                    class="hamburger-line">
                    <rect x="0" y="8" width="600" height="10" fill="white"></rect> <!-- Aumentar a altura aqui -->
                </svg>

                <!-- Linha 2 -->
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" width="80px" height="10px"
                    class="hamburger-line">
                    <rect x="0" y="24" width="600" height="10" fill="white"></rect> <!-- Aumentar a altura aqui -->
                </svg>

                <!-- Linha 3 -->
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" width="80px" height="10px"
                    class="hamburger-line">
                    <rect x="0" y="40" width="600" height="10" fill="white"></rect> <!-- Aumentar a altura aqui -->
                </svg>
            </div>

        </div>

        </div>
    </aside>
    <div id="fade" class="hide"></div>

    <main>
        <section class="dash">
            <div class="Titulo">
                <h1>Uso dos Componentes</h1>
            </div>
            <!-- Gráfico de Barras -->
            <div class="chartSup">
                <div class="table-container">
                    <h3>Servidores com Alertas</h3>
                    <table>
                        <thead>

                        </thead>
                        <tbody id="serverTable">
                            <!-- Dados dinâmicos -->
                        </tbody>
                    </table>
                </div>


            </div>

            <div class="chartInf">
                <!-- Gráfico de Linhas -->
                <div class="chart-container">
                    <div class="supsDashs">
                        <div class="informacao">
                            <div class="title">Média Mensal</div>
                            <div class="tooltip-container">
                                <i class="fas fa-info-circle" id="infoIcon"></i> <!-- Ícone de informação -->
                                <div class="tooltip-box" id="msgBox">
                                    <span class="tooltip-message">Gráfico mostrando a média mensal de uso dos componentes do servidor. Eixo Y: Frequência de uso; Eixo X: Meses.
                                    </span>
                                </div>
                            </div>
                        </div>
                        <select class="opcao" id="recursoSelecionado3">
                            <option value="cpu">CPU</option>
                            <option value="ram">RAM</option>
                        </select>


                    </div>
                    <div id="lineChart" class="lineChart"></div>
                </div>

                <!-- Heatmap -->
                <div class="chart-container">
                    <div class="supsDashs">
                        <div class="informacao">
                            <div class="title">Uso Diário</div>
                            <div class="tooltip-container">
                                <i class="fas fa-info-circle" id="infoIcon"></i> <!-- Ícone de informação -->
                                <div class="tooltip-box" id="msgBox">
                                    <span class="tooltip-message">
                                        Mapa de Calor que exibe o uso detalhado dos componentes do servidor.
                                        <br><br>
                                        <strong>Legenda:</strong>
                                        <ul class="chart-legend">
                                            <li><span class="legend-color" style="background-color:#099478;"></span> Uso entre 100% - 90%</li>
                                            <li><span class="legend-color" style="background-color: #0BA385;"></span> Uso entre 80% - 70%</li>
                                            <li><span class="legend-color" style="background-color: #3db19a;"></span> Uso entre 60% - 50%</li>
                                            <li><span class="legend-color" style="background-color: #53d4bb;"></span> Uso entre 40% - 30%</li>
                                            <li><span class="legend-color" style="background-color: #7de6d1;"></span> Uso entre 20% - 10%</li>
                                            <li><span class="legend-color" style="background-color: #d8e9e9;"></span> Uso entre 10% - 0%</li>
                                        </ul>
                                    </span>
                                </div>
                                
                            </div>
                        </div>
                    </div>
                    <div id="heatmapChart" class="heatmapChart"></div>
                </div>
            </div>

            <div class="sla">
                <div class="chart-container">
                    <div class="supsDashs">
                        <div class="informacao">
                            <div class="title">Ranking de Captura</div>
                            <div class="tooltip-container">
                                <i class="fas fa-info-circle" id="infoIcon"></i> <!-- Ícone de informação -->
                                <div class="tooltip-box" id="msgBox">
                                    <span class="tooltip-message">Gráfico mostrando Ranking de uso dos componentes por servidor. Eixo Y: Frequência de uso; Eixo X: Servidor.</span>
                                </div>
                            </div>
                        </div>
                        <select class="opcao" id="recursoSelecionado2">
                            <option value="cpu">CPU</option>
                            <option value="ram">RAM</option>
                        </select>


                    </div>
                    <div id="barChart" class="barChart" style="overflow-x: auto; max-width: 100%;"></div>

                </div>
            </div>


        </section>
    </main>

</body>

</html>

<script>

    // serverMax -- Gráfico de Barras
    // serverMax -- Gráfico de Barras
    document.addEventListener("DOMContentLoaded", () => {
        const recursoMap = {
            cpu: 1,
            disco: 3,
            ram: 2
        };

        const selectRecurso = document.getElementById("recursoSelecionado2");
        const barChartContainer = document.querySelector("#barChart");

        // Inicializa o gráfico ao carregar a página
        ListarCapturas("cpu");

        // Atualiza o gráfico ao mudar a seleção
        selectRecurso.addEventListener("change", (event) => {
            const recursoSelecionado = event.target.value;
            ListarCapturas(recursoSelecionado);
        });

        function ListarCapturas(recursoSelecionado) {
            const fkRecurso = recursoMap[recursoSelecionado];
            if (!fkRecurso) {
                console.error("Recurso inválido selecionado!");
                return;
            }

            barChartContainer.innerHTML = "";

            fetch(`/individual/serverMax/${fkRecurso}`, {
                method: "GET"
            })
                .then((resposta) => {
                    if (resposta.status === 204) {
                        console.log("Não há capturas disponíveis.");
                        return;
                    }

                    return resposta.json();
                })
                .then((alertas) => {
                    if (!alertas || alertas.length === 0) {
                        console.log("Nenhum dado disponível para o recurso selecionado.");
                        return;
                    }

                    const servidores = alertas.map((registro) => registro.nomeMaquina);
                    const valores = alertas.map((registro) => registro.valorRegistrado);

                    if (servidores.length === 0 || valores.length === 0) {
                        console.log("Os dados retornados estão incompletos ou inválidos.");
                        return;
                    }

                    const barOptions = {
                        chart: {
                            type: "bar",
                            height: 300,
                            width: servidores.length * 50, // Largura ajustada dinamicamente
                            toolbar: {
                                show: false // Opcional: Remove a barra de ferramentas do gráfico
                            }
                        },
                        title: {
                            text: `${recursoSelecionado.toUpperCase()}`
                        },
                        series: [
                            {
                                name: "Uso do Componente",
                                data: valores
                            }
                        ],
                        colors: ["#0BA385"], // Define a cor das barras
                        xaxis: {
                            categories: servidores
                        }


                    };

                    const chart = new ApexCharts(barChartContainer, barOptions);
                    chart.render();
                })
                .catch((erro) => {
                    console.error(`#ERRO: ${erro}`);
                });
        }
    });

    // ranking -- Tabelas Dinânicas
    document.addEventListener("DOMContentLoaded", () => {
        const serverTable = document.getElementById("serverTable");

        // Inicializa a tabela ao carregar a página com a consulta para ranking de recursos
        ListarCapturas();

        function ListarCapturas() {
            // Limpa a tabela antes de adicionar novos dados
            serverTable.innerHTML = "";

            // Requisição para buscar os dados de ranking
            fetch("/individual/ranking", {
                method: "GET"
            })
                .then((resposta) => {
                    if (resposta.status === 204) {
                        console.log("Não há capturas disponíveis.");
                        return;
                    }
                    return resposta.json();
                })
                .then((alertas) => {
                    if (!alertas || alertas.length === 0) {
                        console.log("Nenhum dado disponível para o recurso selecionado.");
                        return;
                    }

                    // Cabeçalho da tabela
                    const headerRow = document.createElement("tr");

                    // Adicione os ícones com tooltip ao lado do texto do cabeçalho
                    headerRow.innerHTML = `
                                                        <th>Servidor
                                    <div class="info-container">
                                        <i class="fas fa-info-circle"></i>
                                        <div class="info-box">
                                            <span class="msg">Nome do servidor monitorado.</span>
                                        </div>
                                    </div>
                                </th>
                                <th>CPU
                                    <div class="info-container">
                                        <i class="fas fa-info-circle"></i>
                                        <div class="info-box">
                                            <span class="msg">Uso máximo do processador registrado em megabytes(MB).</span>
                                        </div>
                                    </div>
                                </th>
                                <th>RAM
                                    <div class="info-container">
                                        <i class="fas fa-info-circle"></i>
                                        <div class="info-box">
                                            <span class="msg">Uso máximo da memória RAM registrado em megabytes(MB).</span>
                                        </div>
                                    </div>
                                </th>
                            `;

                    // Anexe a linha do cabeçalho à tabela
                    serverTable.appendChild(headerRow);



                    // Preenche a tabela com os dados dos servidores
                    alertas.forEach((registro) => {
                        const row = document.createElement("tr");
                        row.innerHTML = `
                        <td>${registro.Servidor}</td>
                        <td>${registro.CPU ? parseFloat(registro.CPU).toFixed(2) : "N/A"}%</td>
                        <td>${registro.RAM ? parseFloat(registro.RAM).toFixed(2) : "N/A"}%</td>
                    `;
                        serverTable.appendChild(row);
                    });
                })
                .catch((erro) => {
                    console.error(`#ERRO: ${erro}`);
                });
        }
    });

    // picosMensal -- Gráfico de Linhas
    document.addEventListener("DOMContentLoaded", () => {
        const recursoMap = {
            cpu: 1,
            ram: 2
        };

        const selectRecurso = document.getElementById("recursoSelecionado3");
        const lineChartContainer = document.querySelector("#lineChart");

        // Inicializa o gráfico ao carregar a página
        ListarCapturas("cpu");

        // Atualiza o gráfico ao mudar a seleção
        selectRecurso.addEventListener("change", (event) => {
            const recursoSelecionado = event.target.value;
            ListarCapturas(recursoSelecionado);
        });

        function ListarCapturas(recursoSelecionado) {
            const fkRecurso = recursoMap[recursoSelecionado];
            if (!fkRecurso) {
                console.error("Recurso inválido selecionado!");
                return;
            }

            lineChartContainer.innerHTML = "";  // Limpa o gráfico anterior

            fetch(`/individual/picosMensal/${fkRecurso}`, {  // Chama o endpoint correto
                method: "GET"
            })
                .then((resposta) => {
                    if (resposta.status === 204) {
                        console.log("Não há capturas disponíveis.");
                        return;
                    }

                    return resposta.json();
                })
                .then((dadosMensais) => {
                    if (!dadosMensais || dadosMensais.length === 0) {
                        console.log("Nenhum dado disponível para o recurso selecionado.");
                        return;
                    }

                    // Mapeia os dados retornados para os valores e meses
                    const meses = dadosMensais.map((registro) => registro.mes);
                    const valores = dadosMensais.map((registro) => registro.valorRegistrado);

                    if (meses.length === 0 || valores.length === 0) {
                        console.log("Os dados retornados estão incompletos ou inválidos.");
                        return;
                    }

                    // Configuração do gráfico de linha
                    var lineOptions = {
                        chart: {
                            type: 'line',
                            height: 300
                        },
                        series: [{
                            name: 'Uso Mensal',
                            data: valores
                        }],
                        xaxis: {
                            categories: meses,
                            title: {
                                text: 'Meses'
                            }
                        },
                        title: {
                            text: `${recursoSelecionado.toUpperCase()}`
                        },

                        dataLabels: {
                            enabled: false
                        },
                        colors: ['#0BA385'],  // Adicionando a cor desejada
                    };

                    // Renderiza o gráfico
                    const chart = new ApexCharts(lineChartContainer, lineOptions);
                    chart.render();
                })
                .catch((erro) => {
                    console.error(`#ERRO: ${erro}`);
                });
        }
    });

    // UsoPorHora -- Mapa de calor
    document.addEventListener("DOMContentLoaded", () => {
        const recursoMap = {
            cpu: 1,
            ram: 2
        };

        const selectRecurso = document.getElementById("recursoSelecionado3");
        const heatmapContainer = document.querySelector("#heatmapChart");

        // Inicializa o gráfico de mapa de calor ao carregar a página
        ListarCapturas("cpu");

        // Atualiza o gráfico de mapa de calor ao mudar a seleção
        selectRecurso.addEventListener("change", (event) => {
            const recursoSelecionado = event.target.value;
            ListarCapturas(recursoSelecionado);
        });

        function ListarCapturas(recursoSelecionado) {
            const fkRecurso = recursoMap[recursoSelecionado];
            if (!fkRecurso) {
                console.error("Recurso inválido selecionado!");
                return;
            }

            heatmapContainer.innerHTML = "";

            fetch(`/individual/UsoPorHora/${fkRecurso}`, {
                method: "GET"
            })
                .then((resposta) => {
                    if (resposta.status === 204) {
                        console.log("Não há capturas disponíveis.");
                        return;
                    }

                    return resposta.json();
                })
                .then((alertas) => {
                    if (!alertas || alertas.length === 0) {
                        console.log("Nenhum dado disponível para o recurso selecionado.");
                        return;
                    }

                    const valores = alertas.map((registro) => registro.valorRegistrado); // Y
                    const diasDaSemana = alertas.map((registro) => registro.dia_semana); // Recebe o dia da semana do banco
                    // x


                    // dado
                    const horas = alertas.map((registro) => new Date(registro.dtHora).getHours()); // Horas de 0 a 23

                    if (valores.length === 0 || diasDaSemana.length === 0 || horas.length === 0) {
                        console.log("Os dados retornados estão incompletos ou inválidos.");
                        return;
                    }

                    // Inicializando as séries com dados aleatórios para cada dia da semana (segunda a domingo)
                    const diasSemana = ['Segunda-feira', 'Terça-feira', 'Quarta-feira', 'Quinta-feira', 'Sexta-feira', 'Sábado', 'Domingo'];
                    const seriesData = diasSemana.map((dia, diaIndex) => {
                        return {
                            name: dia,
                            data: Array.from({ length: 24 }, (_, horaIndex) => {
                                const valor = valores.find((valor, index) => diasDaSemana[index] === diaIndex + 1 && horas[index] === horaIndex);
                                return {
                                    x: `${horaIndex}:00`,
                                    y: valor ? valor : Math.floor(Math.random() * 100) // Se não houver valor, atribui aleatório
                                };
                            })
                        };
                    });

                    var heatmapOptions = {
                        chart: {
                            type: 'heatmap',
                            height: 350
                        },
                        series: seriesData, // Definindo as séries dinamicamente
                        xaxis: {
                            type: 'category',
                            title: {
                                text: 'Hora do Dia'
                            }
                        },
                        yaxis: {
                            title: {
                                text: 'Dia da Semana'
                            }
                        },
                        title: {
                            text: `${recursoSelecionado.toUpperCase()}`
                        },

                        dataLabels: {
                            enabled: false
                        },
                        colors: ['#0BA385']
                    };

                    const chart = new ApexCharts(heatmapContainer, heatmapOptions);
                    chart.render();
                })
                .catch((erro) => {
                    console.error(`#ERRO: ${erro}`);
                });
        }
    });



    document.addEventListener("DOMContentLoaded", () => {
        const menuHamburguer = document.getElementById('menu-hamburguer');
        const navLinks = document.getElementById('navLinks');

        // Alterna a classe "active" no menu de navegação
        menuHamburguer.addEventListener('click', () => {
            console.log("EU ESTOU OBSERVANDO..")
            navLinks.classList.toggle('active');
            menuHamburguer.classList.toggle('open');
        });

        // Iniciar a plotagem do gráfico quando a página carregar
        iniciarAtualizacao();
    });

    document.addEventListener("DOMContentLoaded", () => {
        const infoIcon = document.getElementById("infoIcon");
        const msgBox = document.getElementById("msgBox");

        // Mostrar mensagem no hover
        infoIcon.addEventListener("mouseenter", () => {
            msgBox.style.display = "block";
        });

        // Esconder mensagem ao sair do hover
        infoIcon.addEventListener("mouseleave", () => {
            msgBox.style.display = "none";
        });
    });


</script>