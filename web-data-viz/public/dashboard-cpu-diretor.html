<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard CPU | EyesAnalytic</title>
    <script src="../js/aside-menu.js"></script>
    <link rel="shortcut icon" href="./assets/svg/Logo.svg" type="image/x-icon">
    <link rel="stylesheet" href="./css/pages/dashboard-cpu-diretor.css">
    <link rel="stylesheet" href="./css/pages/aside-menu.css">
    <!-- <link rel="stylesheet" href="./css/pages/espec-servidores.css"> -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Bootstrap CSS  --><!-- Bootstrap CSS  -->
    <!-- <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-eOJMYsd53ii+scO/bJGFsiCZc+5NDVN2yr8+0RDqr0Ql0h+rP48ckxlpbzKgwra6" crossorigin="anonymous">
    < Bootstrap JavaScript Bundle -->
    <!-- <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-JEW9xMcG8R+pH31jmWH6WWP0WintQrMb4s7ZOdauHnUtxwoG2vI5DkLtS3qm9Ekf"
        crossorigin="anonymous"></script> -->
</head>


</head>


</head>

<body onload="listarServidores(), listarHoras()">
    <aside id="aside-menu">
        <img src="../assets/svg/Logo.svg" alt="Logo" class="asideLogo">

        <ul id="navLinks">
            <a href="../lista-alertas.html" class="outros">
                <li>
                    <img src="../assets/svg/alert-svgrepo-com.svg" alt="Alerta">
                    <span>Alertas</span>
                </li>
            </a>

            <a href="../dashboard/dash-diretor.html" class="outros">
                <li>
                    <img src="../assets/svg/dashboard-svgrepo-com.svg" alt="Dashboard">
                    <span>Dashboard</span>
                </li>
            </a>

            <a href="../espec-servidores.html" class="outros">
                <li>
                    <img src="../assets/svg/servidor.svg" alt="Rede">
                    <span>Servidores</span>
                </li>
            </a>

            <a href="../funcionario-diretor.html" class="outros">
                <li>
                    <img src="../assets/svg/user-svgrepo-com.svg" alt="Usuário">
                    <span>Funcionários</span>
                </li>
            </a>

            <a href="../metricas-diretor.html" class="outros">
                <li>
                    <img src="../assets/svg/chamados.svg" alt="Chamados">
                    <span>Métricas</span>
                </li>
            </a>

            <a href="./index.html" class="outros">
                <li>
                    <img src="../assets/svg/exit-svgrepo-com.svg" alt="Saída">
                    <span>Sair</span>
                </li>
            </a>

        </ul>
        <div class="menu" id="menu-hamburguer">
            <div class="menu" id="menu-hamburguer">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" width="80px" height="10px"
                    class="hamburger-line">
                    <rect x="0" y="8" width="600" height="10" fill="white"></rect> <!-- Aumentar a altura aqui -->
                </svg>

                <!-- Linha 2 -->
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" width="80px" height="10px"
                    class="hamburger-line">
                    <rect x="0" y="24" width="600" height="10" fill="white"></rect> <!-- Aumentar a altura aqui -->
                </svg>

                <!-- Linha 3 -->
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" width="80px" height="10px"
                    class="hamburger-line">
                    <rect x="0" y="40" width="600" height="10" fill="white"></rect> <!-- Aumentar a altura aqui -->
                </svg>
            </div>

        </div>

        </div>
    </aside>
    <div id="fade" class="hide"></div>

    <main>
        <h2>Uso da CPU</h2>
        <section class="servidores" id="conteudo">
            <!-- <article class="alertas" id="lista"> -->
            </article>

            <div id="conteudoServidores" class="conteudoServidores">
                <h3 class="tituloServidores">Firewalls em Sobrecarga</h3>

                <div class="listagemServidores" id="listagemServidores">

                </div>
            </div>

            <div id="modal" class="modal">
            </div>


            <div class="graficoRegressao">
                <div class="tituloRegresssao">
                    <h3>Tendência de Uso</h3>
                    <select id="servidores">

                    </select>
                </div>

                <canvas id="myChart3"></canvas>
            </div>
        </section>


        <section class="graficosInferiores">
            <div class="graficoMedia">
                <h3>Média de Uso x Máximo de Uso</h3>
                <canvas class="grafico_media_max" id="myChart2"></canvas>
                <!-- <canvas class="grafico_media_max" id="myChart" width="100" height="20" style="box-sizing: border-box;height: 607px;width: 20px;"></canvas> -->
            </div>
            <div class="grafico4">
                <h3>Horas acima da métrica na semana</h3>
                <canvas class="grafico_media_max" id="myChart"></canvas>

                <!-- <canvas class="grafico_media_max" id="myChart" width="100" height="20" style="box-sizing: border-box;height: 607px;width: 20px;"></canvas> -->
            </div>

        </section>
    </main>
</body>

</html>
<script>

    //FUNÇÃO PARA LISTAR TODOS OS SERVIDORES DE UMA DETERMINADA EMPRESA
    function listarServidores() {
        var fkEmpresa = sessionStorage.FK_EMPRESA;
        var lista = document.getElementById("lista");

        fetch(`servidor/listarPorUsoCPU/${fkEmpresa}`, {
            method: "GET",
            headers: {
                "Content-Type": "application/json"
            }
        }).then(function (resposta) {
            resposta.json().then(function (resposta) {
                resposta.forEach(element => {
                    let conteudo = document.getElementById("listagemServidores");
                    let openModal = document.createElement("div");
                    openModal.className = "openModal";

                    let frameAlertas = document.createElement("div");
                    frameAlertas.className = "frameAlertas";

                    let abrir = document.createElement("div");
                    abrir.className = "abrir";
                    abrir.id = "openModal";
                    abrir.onclick = function () {
                        listarEspecifico(element.idMaquina);
                    };

                    let titulo = document.createElement("h3");
                    // titulo.onclick = function () {
                    //     listarEspecifico(element.idMaquina);
                    // };
                    titulo.innerText = element.nomeMaquina;

                    // Adicionando opções de CPU, Memória e Disco
                    let opcoes = document.createElement("div");
                    opcoes.className = "opcoes";
                    // opcoes.onclick = function () {
                    //     listarEspecifico(element.idMaquina);
                    // };

                    // CPU
                    let opcaoCPU = document.createElement("div");
                    opcaoCPU.className = "opcao";
                    opcaoCPU.innerHTML = "<h4>CPU:</h4><p><span class='textoVermelho'>" +
                        (element.CPU !== undefined ? Math.floor(element.CPU) : "N/A") +
                        "%</span></p>";

                    // Memória
                    let opcaoMemoria = document.createElement("div");
                    opcaoMemoria.className = "opcao";
                    opcaoMemoria.innerHTML = "<h4>RAM:</h4>" +
                        (element.RAM !== undefined ? Math.floor(element.RAM) : "N/A") +
                        "%</span></p>";

                    // Disco
                    let opcaoDisco = document.createElement("div");
                    opcaoDisco.className = "opcao";
                    opcaoDisco.innerHTML = "<h4>Disco:</h4>" +
                        (element.Disco_Rigido !== undefined ? Math.floor(element.Disco_Rigido) : "N/A") +
                        "%</span></p>";

                    // Adicionando opções à div 'opcoes'
                    opcoes.appendChild(opcaoCPU);
                    opcoes.appendChild(opcaoMemoria);
                    opcoes.appendChild(opcaoDisco);

                    // Montando o conteúdo do modal
                    abrir.appendChild(titulo);
                    abrir.appendChild(opcoes);
                    frameAlertas.appendChild(abrir);
                    openModal.appendChild(frameAlertas);


                    // Adicionando o modal completo ao DOM
                    document.body.appendChild(openModal);

                    conteudo.appendChild(openModal);
                });
            });
        })
    }

    // Gráfico Horas --------------------------------------------------------------------------------------------------------
    const ctx2 = document.getElementById('myChart');
    // var idMaquina = sessionStorage.ID_MAQUINA;
    function listarHoras() {
        fetch(`servidor/listarDiferencaHoras`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Erro na requisição: ' + response.statusText);
                }
                return response.json();
            })
            .then(data => {
                const diferenca_horas = data.map(item => item.diferenca_horas);

                const nomeMaquina = data.map(item => item.nomeMaquina);
                console.log('Diferença horas:', diferenca_horas);
                console.log('Nome Servidor:', nomeMaquina);
                atualizarGrafico2(diferenca_horas, nomeMaquina);
            })
            .catch(error => {
                console.error('Erro: ', error);
            });
    }
    function atualizarGrafico2(diferenca_horas, nomeMaquina) {
        new Chart(ctx2, {
            type: 'bar',
            data: {
                labels: nomeMaquina,
                datasets: [{
                    label: 'Horas',
                    data: diferenca_horas,
                    borderWidth: 1,
                    backgroundColor: '#08836A'
                }]
            },
            options: {
                responsive: true,
                indexAxis: 'y',
                x: {
                    stacked: true
                },
                y: {
                    stacked: true
                }
            }

        });

    }


    // Gráfico Média e Máximo
    const ctx = document.getElementById('myChart2');
    var color1 = '#0BA385';
    var color2 = '#CE1919';

    var labels = [];
    var data = [];

    var fkEmpresa = sessionStorage.FK_EMPRESA;
    fetch(`servidor/listarMediaMaximo/${fkEmpresa}`)
        .then(response => {
            if (!response.ok) {
                throw new Error('Erro na requisição: ' + response.statusText);
            }
            return response.json();
        })
        .then(data => {
            const mediaCPU = data.map(item => item.media_cpu);
            const maxCPU = data.map(item => item.max_cpu);

            const nomeServdior = data.map(item => item.nomeMaquina);

            console.log('Média de CPU:', mediaCPU);
            console.log('Máxima de CPU:', maxCPU);


            atualizarGrafico(mediaCPU, maxCPU, nomeServdior);
        })
        .catch(error => {
            console.error('Erro: ', error);
        });


    var backgroundColors = [];
    data.forEach((value, index) => {
        if (index % 2 === 0) {
            backgroundColors.push(color1);
        } else {
            backgroundColors.push(color2);
        }
    });

    var borderColors = backgroundColors.map(color => color.replace('0.2', '1'));
    function atualizarGrafico(mediaCPU, maxCPU, nomeServdior) {
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: nomeServdior,
                datasets: [{
                    label: 'Média uso de CPU',
                    data: mediaCPU,
                    // borderWidth: 1,
                    backgroundColor: color1
                },
                {
                    label: 'Máximo de uso de CPU',
                    data: maxCPU,
                    // borderWidth: 1,
                    backgroundColor: color2
                }],

            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }

    // Regressão linear-----------------------------------------------------------------------------------------------

    // Função para carregar os dados ao selecionar um servidor
    // Variável global para armazenar o gráfico
    let myChart = null;

    // Função para carregar os dados ao selecionar um servidor
    function carregarDadosPorServidor(idMaquinaSelecionado) {
        if (idMaquinaSelecionado) {  // Verifica se foi selecionado algum valor
            // Requisição para obter os dados específicos do servidor selecionado
            fetch(`servidor/listarDadoEspecifico/${idMaquinaSelecionado}`, {
                method: "GET",
                headers: {
                    "Content-Type": "application/json"
                }
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Erro na requisição do dado específico: ' + response.statusText);
                    }
                    return response.json();
                })
                .then(data => {
                    // Transformando os dados
                    const registro = data.map(item => item.registro); // Valores do uso da CPU
                    const dtHora = data.map(item => new Date(item.dtHora)); // Datas formatadas

                    const datasApenas = dtHora.map(d => {
                        return new Date(d.getFullYear(), d.getMonth(), d.getDate()); // Apenas ano, mês e dia
                    });


                    console.log('Uso da CPU (registro):', registro);
                    console.log('Data', datasApenas);

                    // Função para calcular a regressão linear
                    function regressaoLinear(x, y) {
                        const n = x.length;
                        const sumX = x.reduce((acc, val) => acc + val, 0);
                        const sumY = y.reduce((acc, val) => acc + val, 0);
                        const sumXY = x.reduce((acc, val, idx) => acc + val * y[idx], 0);
                        const sumX2 = x.reduce((acc, val) => acc + val * val, 0);

                        const b = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);
                        const a = (sumY - b * sumX) / n;

                        return { a, b };
                    }


                    // Calculando a regressão linear
                    const { a, b } = regressaoLinear(
                        dtHora.map(d => d.getTime()), // Convertendo para timestamp
                        registro
                    );

                    console.log('Coeficientes da regressão linear:', { a, b });

                    // **NOVO**: Criar um intervalo contínuo de timestamps
                    const intervaloLinha = [];
                    const minTimestamp = Math.min(...dtHora.map(d => d.getTime()));
                    const maxTimestamp = Math.max(...dtHora.map(d => d.getTime()));
                    const passo = 60 * 60 * 1000; // Intervalo de 1 hora

                    for (let t = minTimestamp; t <= maxTimestamp; t += passo) {
                        intervaloLinha.push(t);
                    }

                    // **NOVO**: Calcular os pontos da linha de regressão
                    const dadosLinhaRegressao = intervaloLinha.map(t => ({
                        x: t,
                        y: a + b * t
                    }));

                    // Se o gráfico já existir, destruímos a instância anterior
                    if (myChart) {
                        myChart.destroy();
                    }

                    // Criando o gráfico novamente
                    const ctx3 = document.getElementById('myChart3').getContext('2d');
                    myChart = new Chart(ctx3, {
                        type: 'scatter',
                        data: {
                            datasets: [
                                {
                                    label: 'Dados (Uso da CPU)',
                                    data: datasApenas.map((date, idx) => ({
                                        x: date.getTime(),
                                        y: registro[idx]
                                    })),
                                    backgroundColor: 'rgba(255, 99, 132, 1)',
                                    borderColor: 'rgba(255, 99, 132, 1)',
                                    borderWidth: 1
                                },

                                {
                                    label: 'Linha de Regressão',
                                    data: dadosLinhaRegressao, // Linha contínua
                                    type: 'line', // Assegura que é uma linha
                                    fill: false,
                                    borderColor: 'rgba(75, 192, 192, 1)', // Cor da linha
                                    borderWidth: 0.5, // Linha mais fina
                                    tension: 0 // Mantém a linha reta
                                }

                            ]
                        },
                        options: {
                            scales: {
                                x: {
                                    type: 'linear',
                                    position: 'bottom',
                                    title: {
                                        display: true,
                                        text: 'Data'
                                    },
                                    ticks: {
                                        callback: function (value) {
                                            const date = new Date(value);
                                            return date.toLocaleDateString();
                                        }
                                    }
                                },
                                y: {
                                    beginAtZero: false,
                                    title: {
                                        display: true,
                                        text: 'Uso da CPU (%)'
                                    }
                                }
                            },
                            responsive: true
                        }
                    });
                })
                .catch(error => {
                    console.error('Erro:', error);
                });
        }
    }

    // Requisição para listar os servidores (já existente no seu código)
    fetch(`servidor/listarPorUsoCPU/${fkEmpresa}`, {
        method: "GET",
        headers: {
            "Content-Type": "application/json"
        }
    })
        .then(response => {
            if (!response.ok) {
                throw new Error('Erro na requisição: ' + response.statusText);
            }
            return response.json();
        })
        .then(data => {
            // Transformando os dados
            const nomeMaquina = data.map(item => item.nomeMaquina); // Nomes das máquinas
            const idMaquina = data.map(item => item.idMaquina); // IDs das máquinas

            const selectElement = document.getElementById("servidores");

            // Limpar as opções existentes, mantendo apenas a padrão
            // selectElement.innerHTML = '<option value="">Selecione...</option>';

            // Adicionar as opções dinamicamente
            data.forEach((item, index) => {
                const option = document.createElement("option");
                option.value = item.idMaquina; // Define o ID como valor
                option.textContent = item.nomeMaquina; // Define o nome da máquina como texto visível
                if (index === 0) {
                    option.selected = true; // Define o primeiro item como selecionado
                }
                selectElement.appendChild(option);
            });

            // Carregar dados para o primeiro item da lista (primeiro servidor)
            const idMaquinaEspecifico = idMaquina[0];
            carregarDadosPorServidor(idMaquinaEspecifico);

            // Adicionar evento de mudança para atualizar os dados quando o ID do servidor mudar
            selectElement.addEventListener("change", (event) => {
                carregarDadosPorServidor(event.target.value);
            });
        })
        .catch(error => {
            console.error('Erro:', error);
        });


</script>